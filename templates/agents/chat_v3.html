<!-- agents/templates/agents/chat_v3.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Research Assistant - Gamma Intelligence</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <!-- Include marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include DOMPurify for security -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Include html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: 100%;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 100;
            width: 40px;
            height: 40px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mobile-menu-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        .menu-icon {
            width: 20px;
            height: 2px;
            background-color: var(--text-primary);
            position: relative;
            transition: all 0.3s;
        }

        .menu-icon::before,
        .menu-icon::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background-color: var(--text-primary);
            transition: all 0.3s;
        }

        .menu-icon::before {
            top: -6px;
        }

        .menu-icon::after {
            top: 6px;
        }

        .mobile-menu-toggle.active .menu-icon {
            background-color: transparent;
        }

        .mobile-menu-toggle.active .menu-icon::before {
            top: 0;
            transform: rotate(45deg);
        }

        .mobile-menu-toggle.active .menu-icon::after {
            top: 0;
            transform: rotate(-45deg);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .user-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .back-link {
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 0.8125rem;
            color: var(--primary);
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .new-chat-button {
            margin: 1rem;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-chat-button:hover {
            background-color: var(--primary-dark);
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .sessions-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .session-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .session-item:hover {
            background-color: var(--bg-tertiary);
        }

        .session-item.active {
            background-color: var(--bg-tertiary);
            border-color: var(--primary);
        }

        .session-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            padding-right: 2rem;
        }

        .session-preview {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-delete {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .session-item:hover .session-delete {
            opacity: 1;
        }

        .session-delete:hover {
            color: var(--error);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
            height: 100vh;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-primary);
            flex-shrink: 0;
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            background-color: var(--bg-secondary);
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in;
            position: relative;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-actions {
            position: absolute;
            top: 0.5rem;
            right: 0;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 0.5rem;
        }

        .message-action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-action-btn:hover {
            background-color: var(--bg-primary);
            border-color: var(--text-secondary);
        }

        .message-action-btn.delete {
            color: var(--error);
        }

        .message-action-btn.delete:hover {
            background-color: #fef2f2;
            border-color: var(--error);
        }

        #exportChatBtn {
            background-color: #10b981;
            color: white;
            border: none;
        }

        #exportChatBtn:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background-color: var(--primary);
            color: white;
        }

        .assistant-message .message-avatar {
            background-color: var(--secondary);
            color: white;
        }

        .message-content-wrapper {
            flex: 1;
            max-width: 45rem;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .message-role {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .user-message .message-role {
            color: var(--primary);
        }

        .assistant-message .message-role {
            color: var(--secondary);
        }

        .kb-badge {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 1rem;
        }

        .message-content {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Markdown styles */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .message-content h1 { font-size: 1.5rem; }
        .message-content h2 { font-size: 1.25rem; }
        .message-content h3 { font-size: 1.125rem; }

        .message-content p {
            margin-bottom: 0.75rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }

        .message-content li {
            margin-bottom: 0.25rem;
        }

        .message-content code {
            background-color: var(--bg-tertiary);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .message-content pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }

        .message-content blockquote {
            border-left: 3px solid var(--primary);
            padding-left: 1rem;
            margin: 0.75rem 0;
            color: var(--text-secondary);
        }

        .message-content a {
            color: var(--primary);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75rem;
        }

        .message-content th,
        .message-content td {
            border: 1px solid var(--border);
            padding: 0.5rem;
            text-align: left;
        }

        .message-content th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
        }

        .tool-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            background-color: var(--bg-tertiary);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }

        .tool-indicator.searching {
            color: var(--primary);
            background-color: rgba(37, 99, 235, 0.1);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            gap: 1rem;
            padding: 0 2rem;
            margin-bottom: 1rem;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border-radius: 1rem;
        }

        .typing-dots span {
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Input Area */
        .input-container {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            background-color: var(--bg-primary);
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            max-width: 50rem;
            margin: 0 auto;
            align-items: flex-end;
        }

        .input-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .kb-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .kb-selector label {
            color: var(--text-secondary);
        }

        .kb-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 200px;
        }

        .kb-select:hover {
            border-color: var(--primary);
        }

        .kb-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .model-selector label {
            color: var(--text-secondary);
        }

        .model-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 150px;
        }

        .model-select:hover {
            border-color: var(--primary);
        }

        .model-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .send-button:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .welcome-content {
            text-align: center;
            max-width: 30rem;
        }

        .welcome-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .welcome-text {
            font-size: 1.125rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .welcome-button {
            padding: 0.75rem 2rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .welcome-button:hover {
            background-color: var(--primary-dark);
        }

        /* Error Message */
        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--error);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin: 0 2rem 1rem;
            font-size: 0.875rem;
        }

        /* Success Message */
        .success-message {
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin: 0 2rem 1rem;
            font-size: 0.875rem;
        }

        /* Prompts */
        .prompt-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .prompt-selector label {
            color: var(--text-secondary);
        }

        .prompt-select-wrapper {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .prompt-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 200px;
        }

        .prompt-select:hover {
            border-color: var(--primary);
        }

        .prompt-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .use-prompt-btn {
            padding: 0.375rem 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .use-prompt-btn:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .use-prompt-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* File Manager Styles */
    .file-manager-btn {
        position: relative;
        padding: 0.5rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
    }

    .file-manager-btn:hover {
        background: var(--bg-tertiary);
        border-color: var(--primary);
    }

    .file-manager-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .selected-files-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ef4444;
        color: white;
        font-size: 0.625rem;
        padding: 2px 5px;
        border-radius: 10px;
        min-width: 16px;
        text-align: center;
    }

    /* File Manager Panel */
    .file-manager-panel {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        max-height: 400px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: none;
        flex-direction: column;
    }

    .file-manager-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .file-manager-header h4 {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .close-panel-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0;
        width: 24px;
        height: 24px;
    }

    .file-upload-section {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .upload-new-btn {
        width: 100%;
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .upload-new-btn:hover {
        background: #1a56db;
    }

    .available-files-grid {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.75rem;
    }

    .file-card {
        position: relative;
        padding: 0.75rem;
        background: var(--bg-tertiary);
        border: 2px solid var(--border);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .file-card.selected {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.05);
    }

    .file-checkbox {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .file-delete-btn {
        position: absolute;
        top: 0.25rem;
        right: 0.25rem;
        width: 20px;
        height: 20px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0;
        transition: all 0.2s;
    }

    .file-card:hover .file-delete-btn {
        opacity: 1;
    }

    .file-delete-btn:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .file-icon {
        font-size: 2rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .file-name {
        font-size: 0.75rem;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.2;
    }

    .file-date {
        font-size: 0.625rem;
        color: var(--text-secondary);
        text-align: center;
        margin-top: 0.25rem;
    }

    .file-selection-info {
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border);
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .loading-files {
        grid-column: 1 / -1;
        text-align: center;
        color: var(--text-secondary);
        padding: 2rem;
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
    }

    .toast {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem 1.5rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
        min-width: 250px;
        max-width: 400px;
    }

    .toast.error {
        border-left: 4px solid #ef4444;
    }

    .toast.warning {
        border-left: 4px solid #f59e0b;
    }

    .toast.success {
        border-left: 4px solid #10b981;
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .mobile-menu-toggle {
            display: flex;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.open {
            transform: translateX(0);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .chat-main {
            margin-left: 0;
            width: 100%;
        }

        .chat-header {
            padding-left: 4rem;
        }

        .messages-container {
            padding: 1rem;
            height: calc(100vh - 120px - 140px); /* Account for header and input */
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-primary);
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .kb-selector {
            font-size: 0.8125rem;
        }

        .kb-select {
            font-size: 0.8125rem;
            padding: 0.25rem 0.5rem;
            min-width: 150px;
        }

        .chat-input {
            font-size: 0.875rem;
            padding: 0.625rem 0.875rem;
        }

        .send-button {
            font-size: 0.875rem;
            padding: 0.625rem 1rem;
        }

        .message-content {
            font-size: 0.875rem;
        }

        .welcome-content {
            padding: 1rem;
            max-width: 100%;
        }

        .welcome-title {
            font-size: 1.5rem;
        }

        .welcome-text {
            font-size: 1rem;
        }

        .message-action-btn {
            font-size: 0.625rem;
            padding: 0.125rem 0.25rem;
        }

        .session-info {
            display: none;
        }
    }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Mobile Menu Toggle -->
        <div class="mobile-menu-toggle" id="mobileMenuToggle">
            <div class="menu-icon"></div>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">Gamma Chats</h1>
                <div class="user-info">{{ user.get_full_name|default:user.username }}</div>
                <a href="{% url 'research_summaries:research_summaries' %}" class="back-link">← Back to Research</a>
            </div>

            <button class="new-chat-button" id="newChatButton">+ New Chat</button>

            <div class="sessions-list">
                <h3 class="sessions-title">Recent Chats</h3>
                <div id="sessionsContainer"></div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-content">
                    <h2 class="welcome-title">Welcome to Research Assistant</h2>
                    <p class="welcome-text">
                        Start a new conversation or continue from where you left off.
                        You can optionally use knowledge bases to enhance responses with specific domain knowledge.
                    </p>
                    <button class="welcome-button" id="welcomeNewChatButton">Start New Chat</button>
                </div>
            </div>

            <div id="chatInterface" style="display: none; flex: 1; flex-direction: column; height: 100%; position: relative;">
                <header class="chat-header">
                    <div class="chat-header-content">
                        <div class="chat-title" id="chatTitle">New Chat</div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="message-action-btn" id="clearChatBtn" style="display: none;">Clear Chat</button>
                            <button class="message-action-btn" id="exportChatBtn" style="display: none;">Export</button>
                            <div class="session-info" id="sessionInfo"></div>
                        </div>
                    </div>
                </header>

                <div class="messages-container" id="messagesContainer" style="flex: 1; overflow-y: auto; padding-bottom: 140px;"></div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">AI</div>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <div class="input-container">
                    <div style="max-width: 50rem; margin: 0 auto; position: relative;">
                        <!-- File Manager Panel (Initially Hidden) -->
                        <div class="file-manager-panel" id="fileManagerPanel">
                            <div class="file-manager-header">
                                <h4>Available Files</h4>
                                <button type="button" class="close-panel-btn" id="closePanelBtn">×</button>
                            </div>

                            <div class="file-upload-section">
                                <input type="file" id="fileUploadInput" style="display: none;"
                                       multiple accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.png,.jpeg,.jpg">
                                <button type="button" class="upload-new-btn" id="uploadNewBtn">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M7 10L12 5M12 5H8M12 5V9"/>
                                    </svg>
                                    Upload New File
                                </button>
                            </div>

                            <div class="available-files-grid" id="availableFilesGrid">
                                <div class="loading-files">Loading files...</div>
                            </div>

                            <div class="file-selection-info">
                                <span id="selectedFilesCount">0 files selected (max 3)</span>
                            </div>
                        </div>

                        <!-- Existing controls -->
                        <div class="input-controls">
                            <div class="kb-selector">
                                <label for="knowledgeBaseSelect">Knowledge Base:</label>
                                <select id="knowledgeBaseSelect" class="kb-select">
                                    <option value="">None (General Chat)</option>
                                    {% for kb in knowledge_bases %}
                                    <option value="{{ kb.id }}" title="{{ kb.description }}">
                                        {{ kb.display_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="model-selector">
                                <label for="modelSelect">Model:</label>
                                <select id="modelSelect" class="model-select">
                                    {% for model in available_models %}
                                        <option value="{{ model.key }}"
                                                {% if model.key == 'o3' %}selected{% endif %}
                                                title="{{ model.description }}">
                                            {{ model.display_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="prompt-selector">
                                <label for="promptSelect">Prompts:</label>
                                <div class="prompt-select-wrapper">
                                    <select id="promptSelect" class="prompt-select">
                                        <option value="">Select a prompt...</option>
                                        {% for prompt in user_prompts %}
                                        <option value="{{ prompt.id }}">
                                            {{ prompt.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button id="usePromptBtn" class="use-prompt-btn" disabled>
                                        Use
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="input-wrapper">
                            <!-- NEW: File Manager Button -->
                            <button type="button" class="file-manager-btn" id="fileManagerBtn" title="Manage files">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 4v12m-4-4l4 4 4-4"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16h12"/>
                                </svg>
                                <span class="selected-files-badge" id="selectedFilesBadge" style="display: none;">0</span>
                            </button>

                            <textarea
                                id="chatInput"
                                class="chat-input"
                                placeholder="Ask a question..."
                                rows="1"
                            ></textarea>
                            <button id="sendButton" class="send-button">Send</button>
                        </div>
                    </div>
                </div>

                {{ user_prompts|json_script:"user-prompts-data" }}

            </div>
        </main>
    </div>

    <script>
        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });

        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // State management
        let currentSession = null;
        let isStreaming = false;

        // DOM elements
        const elements = {
            sidebar: document.getElementById('sidebar'),
            mobileMenuToggle: document.getElementById('mobileMenuToggle'),
            sidebarOverlay: document.getElementById('sidebarOverlay'),
            newChatButton: document.getElementById('newChatButton'),
            welcomeNewChatButton: document.getElementById('welcomeNewChatButton'),
            knowledgeBaseSelect: document.getElementById('knowledgeBaseSelect'),
            sessionsContainer: document.getElementById('sessionsContainer'),
            welcomeScreen: document.getElementById('welcomeScreen'),
            chatInterface: document.getElementById('chatInterface'),
            chatTitle: document.getElementById('chatTitle'),
            sessionInfo: document.getElementById('sessionInfo'),
            messagesContainer: document.getElementById('messagesContainer'),
            typingIndicator: document.getElementById('typingIndicator'),
            chatInput: document.getElementById('chatInput'),
            sendButton: document.getElementById('sendButton'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            exportChatBtn: document.getElementById('exportChatBtn')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUserSessions();
            setupEventListeners();
            autoResizeTextarea();
            setupMobileMenu();
            initializeFileManager();
        });

        // Mobile menu functionality
        function setupMobileMenu() {
            elements.mobileMenuToggle.addEventListener('click', toggleSidebar);
            elements.sidebarOverlay.addEventListener('click', closeSidebar);
        }

        function toggleSidebar() {
            elements.sidebar.classList.toggle('open');
            elements.sidebarOverlay.classList.toggle('active');
            elements.mobileMenuToggle.classList.toggle('active');
        }

        function closeSidebar() {
            elements.sidebar.classList.remove('open');
            elements.sidebarOverlay.classList.remove('active');
            elements.mobileMenuToggle.classList.remove('active');
        }

        // Event listeners
        function setupEventListeners() {
            elements.newChatButton.addEventListener('click', createNewChat);
            elements.welcomeNewChatButton.addEventListener('click', createNewChat);
            elements.sendButton.addEventListener('click', sendMessage);
            elements.chatInput.addEventListener('keydown', handleInputKeydown);
            elements.chatInput.addEventListener('input', autoResizeTextarea);
            elements.clearChatBtn.addEventListener('click', clearSession);
            elements.exportChatBtn.addEventListener('click', exportChatToPDF);

            // Add prompt selector functionality
            const promptSelect = document.getElementById('promptSelect');
            const usePromptBtn = document.getElementById('usePromptBtn');

            // Model selection
            const modelSelect = document.getElementById('modelSelect');

            // Store current model selection (optional - for UI feedback)
            let currentModel = 'o3'; // Default model

            modelSelect.addEventListener('change', function() {
                currentModel = this.value;
                console.log('Model changed to:', currentModel);
            });

            // Get the prompts data from the JSON script tag
            const promptsDataElement = document.getElementById('user-prompts-data');
            let userPromptsData = {};
            if (promptsDataElement) {
                const promptsArray = JSON.parse(promptsDataElement.textContent);
                // Convert array to object keyed by ID
                promptsArray.forEach(prompt => {
                    userPromptsData[prompt.id] = prompt.prompt;
                });
            }

            // Enable/disable use button based on selection
            promptSelect.addEventListener('change', function() {
                usePromptBtn.disabled = !this.value;
            });

            // Handle use prompt button click
            usePromptBtn.addEventListener('click', function() {
                const selectedOption = promptSelect.selectedOptions[0];
                if (selectedOption && selectedOption.value) {
                    const promptId = selectedOption.value;
                    const promptContent = userPromptsData[promptId];

                    if (promptContent) {
                        // Get the chat input
                        const chatInput = document.getElementById('chatInput');

                        // Set the prompt content
                        chatInput.value = promptContent;

                        // Trigger input event to handle any auto-resize
                        chatInput.dispatchEvent(new Event('input'));

                        // Auto-resize the textarea to fit content
                        autoResizeTextarea();

                        // Focus on the input
                        chatInput.focus();

                        // Reset the select to placeholder
                        promptSelect.value = '';
                        usePromptBtn.disabled = true;
                    }
                }
            });
        }

        // Create new chat
        async function createNewChat() {
            try {
                const response = await fetch('/agents/api/sessions/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) throw new Error('Failed to create session');

                const data = await response.json();
                currentSession = data.session_id;

                // Update UI
                showChatInterface();
                clearMessages();
                addSystemMessage('Hello! How can I assist you today? You can optionally select a knowledge base above to enhance my responses with specific domain knowledge.');

                // Reload sessions list
                loadUserSessions();

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }

            } catch (error) {
                console.error('Error creating session:', error);
                showError('Failed to create session. Please try again.');
            }
        }

        // Load user sessions
        async function loadUserSessions() {
            try {
                const response = await fetch('/agents/api/sessions/');
                if (!response.ok) throw new Error('Failed to load sessions');

                const data = await response.json();
                displaySessions(data.sessions);

            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Display sessions in sidebar
        function displaySessions(sessions) {
            elements.sessionsContainer.innerHTML = '';

            if (sessions.length === 0) {
                elements.sessionsContainer.innerHTML = '<div class="session-preview">No previous chats</div>';
                return;
            }

            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'session-item';
                if (session.session_id === currentSession) {
                    sessionEl.classList.add('active');
                }

                sessionEl.innerHTML = `
                    <div class="session-title">${session.title}</div>
                    <div class="session-preview">${session.last_message || 'No messages yet'}</div>
                    <button class="session-delete" onclick="event.stopPropagation(); deleteSession('${session.session_id}')" title="Delete session">×</button>
                `;

                sessionEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('session-delete')) {
                        loadSession(session.session_id);
                        // Close sidebar on mobile
                        if (window.innerWidth <= 768) {
                            closeSidebar();
                        }
                    }
                });

                elements.sessionsContainer.appendChild(sessionEl);
            });
        }

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat session?')) return;

            try {
                const response = await fetch(`/agents/api/sessions/${sessionId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) throw new Error('Failed to delete session');

                // If it's the current session, reset to welcome screen
                if (sessionId === currentSession) {
                    currentSession = null;
                    elements.welcomeScreen.style.display = 'flex';
                    elements.chatInterface.style.display = 'none';
                }

                // Reload sessions
                loadUserSessions();

            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Failed to delete session. Please try again.');
            }
        }

        // Load existing session
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/agents/api/sessions/${sessionId}/history/`);
                if (!response.ok) throw new Error('Failed to load session');

                const data = await response.json();
                currentSession = sessionId;

                // Update UI
                showChatInterface();
                elements.chatTitle.textContent = data.title || 'New Chat';
                clearMessages();

                // Display messages
                data.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        addUserMessage(msg.content, msg.knowledge_base, msg.id);
                    } else if (msg.role === 'assistant') {
                        addAssistantMessage(msg.content, msg.knowledge_base, msg.id);
                    }
                });

                // Reload sessions to update active state
                loadUserSessions();

            } catch (error) {
                console.error('Error loading session:', error);
                showError('Failed to load session. Please try again.');
            }
        }

        // Show chat interface
        function showChatInterface() {
            elements.welcomeScreen.style.display = 'none';
            elements.chatInterface.style.display = 'flex';
            elements.sessionInfo.textContent = `Session: ${currentSession.substring(0, 8)}...`;
            elements.clearChatBtn.style.display = 'block';
            elements.exportChatBtn.style.display = 'block';
            elements.chatInput.focus();
        }

        // Send message
        async function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message || !currentSession || isStreaming) return;

            const knowledgeBaseId = elements.knowledgeBaseSelect.value;
            const selectedModel = document.getElementById('modelSelect').value;

            const knowledgeBase = knowledgeBaseId ? {
                id: knowledgeBaseId,
                name: elements.knowledgeBaseSelect.selectedOptions[0].text
            } : null;

            // Add user message
            addUserMessage(message, knowledgeBase);
            elements.chatInput.value = '';
            autoResizeTextarea();

            // Disable input during streaming
            elements.chatInput.disabled = true;
            elements.sendButton.disabled = true;
            isStreaming = true;

            // Close file manager if open
            if (isFileManagerOpen) {
                const fileManagerPanel = document.getElementById('fileManagerPanel');
                const fileManagerBtn = document.getElementById('fileManagerBtn');
                fileManagerPanel.style.display = 'none';
                fileManagerBtn.classList.remove('active');
                isFileManagerOpen = false;
            }

            // Show typing indicator
            showTypingIndicator();

            // Create a placeholder for the assistant message
            let currentMessageEl = null;
            let currentMessageContent = '';

            try {
                const body = {
                    message: message,
                    session_id: currentSession,
                    model: selectedModel,
                    file_ids: Array.from(selectedFileIds)  // Convert Set to Array
                };

                if (knowledgeBaseId) {
                    body.knowledge_base_id = knowledgeBaseId;
                }

                selectedFileIds.clear();
                updateSelectedCount();

                const response = await fetch('/agents/api/chat/stream_new/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Failed to send message');

                // Read SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                switch (data.type) {
                                    case 'content':
                                        if (!currentMessageEl) {
                                            hideTypingIndicator();
                                            currentMessageEl = createAssistantMessage(knowledgeBase);
                                        }
                                        // Accumulate content
                                        currentMessageContent += data.content;
                                        // Render markdown
                                        const contentEl = currentMessageEl.querySelector('.message-content');
                                        const sanitized = DOMPurify.sanitize(marked.parse(currentMessageContent));
                                        contentEl.innerHTML = sanitized;
                                        scrollToBottom();
                                        break;
                                    case 'tool_use':
                                        if (data.tool === 'file_search' && data.status === 'searching') {
                                            showToolIndicator(`Searching ${knowledgeBase.name}...`);
                                        }
                                        break;
                                    case 'info':
                                        console.log('Info:', data.message);
                                        break;
                                    case 'error':
                                        showError(data.error);
                                        break;
                                    case 'done':
                                        // Streaming complete
                                        break;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                // Update chat title if needed
                updateChatTitle();

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message. Please try again.');
            } finally {
                hideTypingIndicator();
                elements.chatInput.disabled = false;
                elements.sendButton.disabled = false;
                isStreaming = false;
                elements.chatInput.focus();
            }
        }

        // Delete message function
        async function deleteMessage(messageId) {
            if (!confirm('Delete this message and all messages after it?')) return;

            try {
                const response = await fetch(`/agents/api/messages/${messageId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) throw new Error('Failed to delete message');

                // Reload the current session to reflect changes
                if (currentSession) {
                    await loadSession(currentSession);
                }

            } catch (error) {
                console.error('Error deleting message:', error);
                showError('Failed to delete message. Please try again.');
            }
        }

        // Clear entire session
        async function clearSession() {
            if (!currentSession) return;
            if (!confirm('Clear all messages in this chat?')) return;

            try {
                const response = await fetch(`/agents/api/sessions/${currentSession}/clear/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) throw new Error('Failed to clear session');

                // Reload the current session
                await loadSession(currentSession);

            } catch (error) {
                console.error('Error clearing session:', error);
                showError('Failed to clear session. Please try again.');
            }
        }

        // Export chat to PDF
        async function exportChatToPDF() {
            if (!currentSession) return;

            try {
                // Create a temporary container for PDF content
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = 'white';
                pdfContent.style.color = '#111827';
                pdfContent.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';

                // Add header with session info
                const header = document.createElement('div');
                header.style.marginBottom = '30px';
                header.innerHTML = `
                    <h1 style="font-size: 24px; margin-bottom: 10px;">Chat Export</h1>
                    <p style="color: #6b7280; font-size: 14px;">Session: ${currentSession}</p>
                    <p style="color: #6b7280; font-size: 14px;">Exported: ${new Date().toLocaleString()}</p>
                    <p style="color: #6b7280; font-size: 14px;">User: {{ user.username }}</p>
                `;
                pdfContent.appendChild(header);

                // Get all messages from the current view
                const messagesContainer = elements.messagesContainer;
                const messages = messagesContainer.querySelectorAll('.message');

                // Process each message
                messages.forEach(msg => {
                    const role = msg.querySelector('.message-role')?.textContent || '';
                    const content = msg.querySelector('.message-content')?.innerHTML || '';
                    const kbBadge = msg.querySelector('.kb-badge')?.textContent || '';

                    // Skip if it's a system message or empty
                    if (!role || !content) return;

                    const messageDiv = document.createElement('div');
                    messageDiv.style.marginBottom = '20px';
                    messageDiv.style.borderBottom = '1px solid #e5e7eb';
                    messageDiv.style.paddingBottom = '15px';

                    // Message header
                    const msgHeader = document.createElement('div');
                    msgHeader.style.marginBottom = '10px';
                    msgHeader.innerHTML = `
                        <strong style="color: ${role === 'You' ? '#2563eb' : '#7c3aed'};">${role}</strong>
                        ${kbBadge ? `<span style="font-size: 12px; color: #6b7280; margin-left: 10px;">[${kbBadge}]</span>` : ''}
                    `;
                    messageDiv.appendChild(msgHeader);

                    // Message content
                    const msgContent = document.createElement('div');
                    msgContent.style.fontSize = '14px';
                    msgContent.style.lineHeight = '1.6';
                    msgContent.innerHTML = content;
                    messageDiv.appendChild(msgContent);

                    pdfContent.appendChild(messageDiv);
                });

                // Configure PDF options
                const opt = {
                    margin: [0, 10, 0, 10],
                    filename: `chat-export-${currentSession.substring(0, 8)}-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    }
                };

                // Generate and save the PDF
                html2pdf().set(opt).from(pdfContent).save();

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.textContent = 'Chat exported successfully!';
                elements.messagesContainer.insertBefore(successMsg, elements.messagesContainer.firstChild);

                // Remove success message after 3 seconds
                setTimeout(() => successMsg.remove(), 3000);

            } catch (error) {
                console.error('Error exporting chat:', error);
                showError('Failed to export chat. Please try again.');
            }
        }

        // Update chat title from first message
        async function updateChatTitle() {
            try {
                const response = await fetch(`/agents/api/sessions/${currentSession}/history/`);
                if (response.ok) {
                    const data = await response.json();
                    elements.chatTitle.textContent = data.title || 'New Chat';
                    loadUserSessions(); // Refresh sidebar
                }
            } catch (error) {
                console.error('Error updating title:', error);
            }
        }

        // Message UI functions
        function clearMessages() {
            elements.messagesContainer.innerHTML = '';
        }

        function addSystemMessage(content) {
            const messageEl = createMessageElement('system', content);
            elements.messagesContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function addUserMessage(content, knowledgeBase, messageId = null) {
            const messageEl = createMessageElement('user', content, knowledgeBase, messageId);
            elements.messagesContainer.appendChild(messageEl);
            scrollToBottom();
        }

        function addAssistantMessage(content, knowledgeBase, messageId = null) {
            const messageEl = createMessageElement('assistant', content, knowledgeBase, messageId);
            elements.messagesContainer.appendChild(messageEl);
            scrollToBottom();
            return messageEl;
        }

        function createAssistantMessage(knowledgeBase) {
            hideTypingIndicator();
            const messageEl = createMessageElement('assistant', '', knowledgeBase);
            elements.messagesContainer.appendChild(messageEl);
            return messageEl;
        }

        function createMessageElement(role, content, knowledgeBase, messageId = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}-message`;
            if (messageId) {
                messageEl.dataset.messageId = messageId;
            }

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : role === 'system' ? 'S' : 'AI';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';

            const header = document.createElement('div');
            header.className = 'message-header';

            const roleLabel = document.createElement('div');
            roleLabel.className = 'message-role';
            roleLabel.textContent = role === 'user' ? 'You' : role === 'system' ? 'System' : 'Assistant';
            header.appendChild(roleLabel);

            if (knowledgeBase && role !== 'system') {
                const kbBadge = document.createElement('span');
                kbBadge.className = 'kb-badge';
                kbBadge.textContent = knowledgeBase.name;
                header.appendChild(kbBadge);
            }

            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';

            // Render markdown for all messages
            if (content) {
                const sanitized = DOMPurify.sanitize(marked.parse(content));
                contentEl.innerHTML = sanitized;
            }

            contentWrapper.appendChild(header);
            contentWrapper.appendChild(contentEl);

            // Add delete button for non-system messages
            if (role !== 'system' && messageId) {
                const actions = document.createElement('div');
                actions.className = 'message-actions';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => {
                    deleteMessage(messageId);
                };

                actions.appendChild(deleteBtn);
                messageEl.appendChild(actions);
            }

            messageEl.appendChild(avatar);
            messageEl.appendChild(contentWrapper);

            return messageEl;
        }

        function showToolIndicator(text) {
            hideTypingIndicator();
            const indicator = document.createElement('div');
            indicator.className = 'tool-indicator searching';
            indicator.innerHTML = `🔍 ${text}`;
            elements.messagesContainer.appendChild(indicator);
            scrollToBottom();
        }

        function showTypingIndicator() {
            elements.typingIndicator.style.display = 'flex';
            elements.messagesContainer.appendChild(elements.typingIndicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            elements.typingIndicator.style.display = 'none';
        }

        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'error-message';
            errorEl.textContent = message;
            elements.messagesContainer.appendChild(errorEl);
            scrollToBottom();
        }

        function scrollToBottom() {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        // Input handling
        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea() {
            const textarea = elements.chatInput;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // File Manager Variables and Functions
        let availableFiles = [];
        let selectedFileIds = new Set();
        let isFileManagerOpen = false;

        // Initialize file manager
        function initializeFileManager() {
            const fileManagerBtn = document.getElementById('fileManagerBtn');
            const fileManagerPanel = document.getElementById('fileManagerPanel');
            const closePanelBtn = document.getElementById('closePanelBtn');
            const uploadNewBtn = document.getElementById('uploadNewBtn');
            const fileUploadInput = document.getElementById('fileUploadInput');

            // Toggle file manager panel
            fileManagerBtn.addEventListener('click', () => {
                isFileManagerOpen = !isFileManagerOpen;
                fileManagerPanel.style.display = isFileManagerOpen ? 'flex' : 'none';
                fileManagerBtn.classList.toggle('active', isFileManagerOpen);

                if (isFileManagerOpen) {
                    loadAvailableFiles();
                }
            });

            // Close panel
            closePanelBtn.addEventListener('click', () => {
                isFileManagerOpen = false;
                fileManagerPanel.style.display = 'none';
                fileManagerBtn.classList.remove('active');
            });

            // Upload new file button
            uploadNewBtn.addEventListener('click', () => {
                fileUploadInput.click();
            });

            // Handle file selection for upload
            fileUploadInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    await uploadFiles(files);
                }
                e.target.value = ''; // Reset input
            });

            // Load files on initialization
            loadAvailableFiles();
        }

        // Load available files from server
        async function loadAvailableFiles() {
            const grid = document.getElementById('availableFilesGrid');
            grid.innerHTML = '<div class="loading-files">Loading files...</div>';

            try {
                const response = await fetch('/agents/api/chat-files/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    availableFiles = data.files;
                    displayFiles();
                } else {
                    throw new Error('Failed to load files');
                }
            } catch (error) {
                console.error('Error loading files:', error);
                grid.innerHTML = '<div class="loading-files">Error loading files</div>';
            }
        }

        // Display files in grid
        function displayFiles() {
            const grid = document.getElementById('availableFilesGrid');

            if (availableFiles.length === 0) {
                grid.innerHTML = '<div class="loading-files">No files available. Upload files to get started.</div>';
                return;
            }

            grid.innerHTML = '';

            availableFiles.forEach(file => {
                const fileCard = createFileCard(file);
                grid.appendChild(fileCard);
            });

            updateSelectedCount();
        }

        // Create file card element
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'file-card';
            card.dataset.fileId = file.openai_file_id;

            if (selectedFileIds.has(file.openai_file_id)) {
                card.classList.add('selected');
            }

            const icon = document.createElement('div');
            icon.className = 'file-icon';
            icon.textContent = getFileIcon(file.filename);

            const name = document.createElement('div');
            name.className = 'file-name';
            name.textContent = file.filename;
            name.title = file.filename;

            const date = document.createElement('div');
            date.className = 'file-date';
            date.textContent = formatRelativeTime(file.upload_date);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'file-checkbox';
            checkbox.checked = selectedFileIds.has(file.openai_file_id);
            checkbox.onclick = (e) => {
                e.stopPropagation();
                toggleFileSelection(file.openai_file_id);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'file-delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = 'Delete file';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteFile(file.openai_file_id, file.id);
            };

            card.onclick = () => {
                toggleFileSelection(file.openai_file_id);
            };

            card.appendChild(icon);
            card.appendChild(name);
            card.appendChild(date);
            card.appendChild(checkbox);
            card.appendChild(deleteBtn);

            return card;
        }

        // Toggle file selection
        function toggleFileSelection(fileId) {
            if (selectedFileIds.has(fileId)) {
                selectedFileIds.delete(fileId);
            } else {
                if (selectedFileIds.size >= 3) {
                    showNotification('Maximum 3 files can be selected', 'warning');
                    return;
                }
                selectedFileIds.add(fileId);
            }

            const card = document.querySelector(`.file-card[data-file-id="${fileId}"]`);
            if (card) {
                card.classList.toggle('selected', selectedFileIds.has(fileId));
                const checkbox = card.querySelector('.file-checkbox');
                if (checkbox) {
                    checkbox.checked = selectedFileIds.has(fileId);
                }
            }

            updateSelectedCount();
        }


        // Update selected files count
        function updateSelectedCount() {
            const count = selectedFileIds.size;

            const infoText = document.getElementById('selectedFilesCount');
            if (infoText) {
                infoText.textContent = `${count} file${count !== 1 ? 's' : ''} selected (max 3)`;
            }

            const badge = document.getElementById('selectedFilesBadge');
            if (badge) {
                if (count > 0) {
                    badge.style.display = 'block';
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Upload files to server
        async function uploadFiles(files) {
            const uploadBtn = document.getElementById('uploadNewBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = 'Uploading...';
            uploadBtn.disabled = true;

            try {
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('report_type', 'Chat Input');
                    formData.append('expiration_rule', '2');

                    const response = await fetch('/agents/api/upload-chat-file/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Upload failed');
                    }
                }

                await loadAvailableFiles();
                showNotification(`Successfully uploaded ${files.length} file(s)`, 'success');

            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Failed to upload files', 'error');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Delete file
        async function deleteFile(openaiFileId, documentId) {
            if (!confirm('Are you sure you want to delete this file?')) {
                return;
            }

            try {
                const response = await fetch(`/agents/api/delete-chat-file/${documentId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (response.ok) {
                    selectedFileIds.delete(openaiFileId);
                    updateSelectedCount();
                    await loadAvailableFiles();
                    showNotification('File deleted successfully', 'success');
                } else {
                    throw new Error('Failed to delete file');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete file', 'error');
            }
        }

        // Helper functions
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': '📄',
                'doc': '📝',
                'docx': '📝',
                'txt': '📃',
                'csv': '📊',
                'xlsx': '📊',
                'xls': '📊'
            };
            return icons[ext] || '📎';
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;

            return date.toLocaleDateString();
        }

        function showNotification(message, type = 'info') {
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>